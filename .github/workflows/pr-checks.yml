name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    name: PR Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: ]]; then
          echo "‚ùå PR title must follow conventional commits format"
          echo "Examples: feat: add new feature, fix: resolve bug, docs: update README"
          exit 1
        fi
        echo "‚úÖ PR title follows conventional commits"

    - name: Check PR description
      run: |
        if [ -z "${{ github.event.pull_request.body }}" ]; then
          echo "‚ö†Ô∏è  PR description is empty. Please add a description."
          exit 1
        fi
        echo "‚úÖ PR has description"

    - name: Check file changes
      run: |
        FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        echo "üìä Files changed: $FILES_CHANGED"
        
        if [ $FILES_CHANGED -gt 50 ]; then
          echo "‚ö†Ô∏è  Large PR: $FILES_CHANGED files changed. Consider splitting into smaller PRs."
        fi

    - name: Check for merge conflicts
      run: |
        git merge-base origin/${{ github.base_ref }} HEAD
        if git merge-tree $(git merge-base origin/${{ github.base_ref }} HEAD) origin/${{ github.base_ref }} HEAD | grep -q '<<<<<'; then
          echo "‚ùå Merge conflicts detected"
          exit 1
        fi
        echo "‚úÖ No merge conflicts"

    - name: Label PR
      uses: actions/labeler@v5
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Build frontend
      working-directory: frontend
      run: npm run build

    - name: Check bundle size
      working-directory: frontend
      run: |
        SIZE=$(du -sb dist | cut -f1)
        SIZE_MB=$((SIZE / 1024 / 1024))
        echo "üì¶ Bundle size: ${SIZE_MB}MB"
        
        if [ $SIZE_MB -gt 5 ]; then
          echo "‚ö†Ô∏è  Bundle size is large: ${SIZE_MB}MB"
        else
          echo "‚úÖ Bundle size is acceptable"
        fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  comment-coverage:
    name: Comment Test Coverage
    runs-on: ubuntu-latest
    needs: pr-checks
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: school_mgmt_test
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      working-directory: backend
      run: npm ci

    - name: Run coverage
      working-directory: backend
      run: npm run test:coverage
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/school_mgmt_test

    - name: Extract coverage percentage
      id: coverage
      working-directory: backend
      run: |
        COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "üìä Coverage: $COVERAGE%"

    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.coverage }}';
          const emoji = coverage >= 80 ? 'üü¢' : coverage >= 70 ? 'üü°' : 'üî¥';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${emoji} Test Coverage Report\n\n**Coverage:** ${coverage}%\n\n${coverage >= 80 ? '‚úÖ Excellent coverage!' : coverage >= 70 ? '‚ö†Ô∏è  Coverage meets minimum threshold (70%)' : '‚ùå Coverage below threshold (70%)'}`
          })
