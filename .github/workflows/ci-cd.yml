name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'

jobs:
  # Job 1: Linting and Code Quality
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      working-directory: backend
      run: npm ci

    - name: Run ESLint (if configured)
      working-directory: backend
      run: npm run lint || echo "ESLint not configured, skipping..."
      continue-on-error: true

  # Job 2: Unit Tests
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: school_mgmt_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      working-directory: backend
      run: npm ci

    - name: Setup test environment
      working-directory: backend
      run: |
        cp .env .env.test || echo "No .env file to copy"
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/school_mgmt_test" > .env.test
        echo "REDIS_ENABLED=true" >> .env.test
        echo "REDIS_URL=redis://localhost:6379" >> .env.test
        echo "NODE_ENV=test" >> .env.test

    - name: Run unit tests
      working-directory: backend
      run: npm run test:unit
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/school_mgmt_test
        REDIS_URL: redis://localhost:6379

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: backend/test-results/
        retention-days: 30

  # Job 3: Integration Tests
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: school_mgmt_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      working-directory: backend
      run: npm ci

    - name: Setup test environment
      working-directory: backend
      run: |
        cp .env .env.test || true
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/school_mgmt_test" > .env.test
        echo "REDIS_ENABLED=true" >> .env.test
        echo "REDIS_URL=redis://localhost:6379" >> .env.test
        echo "NODE_ENV=test" >> .env.test

    - name: Setup test database
      run: |
        # Create tables
        PGPASSWORD=postgres psql -h localhost -U postgres -d school_mgmt_test -f seed_db/tables.sql
        # Seed base data
        PGPASSWORD=postgres psql -h localhost -U postgres -d school_mgmt_test -f seed_db/seed-db.sql
        # Seed test-specific data (admin@test.com user)
        PGPASSWORD=postgres psql -h localhost -U postgres -d school_mgmt_test -f seed_db/test-data.sql

    - name: Run integration tests
      working-directory: backend
      run: npm run test:integration
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/school_mgmt_test
        REDIS_URL: redis://localhost:6379

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: backend/test-results/
        retention-days: 30

  # Job 4: Test Coverage
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: school_mgmt_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      working-directory: backend
      run: npm ci

    - name: Setup test database
      run: |
        # Create tables
        PGPASSWORD=postgres psql -h localhost -U postgres -d school_mgmt_test -f seed_db/tables.sql
        # Seed base data
        PGPASSWORD=postgres psql -h localhost -U postgres -d school_mgmt_test -f seed_db/seed-db.sql
        # Seed test-specific data (admin@test.com user)
        PGPASSWORD=postgres psql -h localhost -U postgres -d school_mgmt_test -f seed_db/test-data.sql

    - name: Run tests with coverage
      working-directory: backend
      run: npm run test:coverage
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/school_mgmt_test

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./backend/coverage/lcov.info
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: backend/coverage/
        retention-days: 30

    - name: Check coverage threshold
      working-directory: backend
      run: |
        COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 70" | bc -l) )); then
          echo "âŒ Coverage below 70%"
          exit 1
        fi
        echo "âœ… Coverage meets threshold (70%)"
      continue-on-error: true

  # Job 5: Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Run npm audit
      working-directory: backend
      run: |
        npm audit --production --audit-level=moderate || true
        npm audit --json > audit-report.json || true

    - name: Upload audit report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit
        path: backend/audit-report.json
        retention-days: 30

  # Job 6: Build Backend
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      working-directory: backend
      run: npm ci --production

    - name: Create build artifact
      working-directory: backend
      run: |
        mkdir -p build
        cp -r src build/
        cp package*.json build/
        cp -r node_modules build/ 2>/dev/null || true

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: backend/build/
        retention-days: 7

  # Job 7: Build Frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Clean install (fix Rollup optional deps bug)
      working-directory: frontend
      run: |
        # Fix for Rollup optional dependencies issue in GitHub Actions
        # See: https://github.com/npm/cli/issues/4828
        # Remove package-lock.json and node_modules as suggested by error
        rm -rf node_modules package-lock.json
        npm cache clean --force
        npm install --legacy-peer-deps

    - name: Build frontend
      working-directory: frontend
      run: npm run build
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:5007' }}
        NODE_OPTIONS: '--max-old-space-size=4096'

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 7

  # Job 8: Docker Build (optional)
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      if: github.event_name == 'push' && secrets.DOCKER_USERNAME != '' && secrets.DOCKER_PASSWORD != ''

    - name: Build and push Backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: ${{ github.event_name == 'push' && secrets.DOCKER_USERNAME != '' }}
        tags: ${{ secrets.DOCKER_USERNAME }}/school-mgmt-backend:${{ github.sha }},${{ secrets.DOCKER_USERNAME }}/school-mgmt-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
      if: secrets.DOCKER_USERNAME != ''

    - name: Build and push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: ${{ github.event_name == 'push' && secrets.DOCKER_USERNAME != '' }}
        tags: ${{ secrets.DOCKER_USERNAME }}/school-mgmt-frontend:${{ github.sha }},${{ secrets.DOCKER_USERNAME }}/school-mgmt-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
      if: secrets.DOCKER_USERNAME != ''

  # Job 9: Deployment (optional)
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.yourapp.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy notification
      run: |
        echo "ðŸš€ Deploying to staging environment"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"

    # Add your deployment steps here
    # Examples:
    # - Deploy to Heroku
    # - Deploy to AWS ECS
    # - Deploy to Kubernetes
    # - Deploy to Vercel/Netlify

  # Job 10: Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, coverage, security]
    if: always()
    
    steps:
    - name: Send notification
      run: |
        echo "ðŸ“Š Pipeline Status:"
        echo "Build Backend: ${{ needs.build-backend.result }}"
        echo "Build Frontend: ${{ needs.build-frontend.result }}"
        echo "Coverage: ${{ needs.coverage.result }}"
        echo "Security: ${{ needs.security.result }}"

    # Add notification integrations here:
    # - Slack
    # - Discord
    # - Email
    # - GitHub Issues
